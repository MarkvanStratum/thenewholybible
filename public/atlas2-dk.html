<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Sikker Checkout</title>
  <meta name="referrer" content="no-referrer">

  <style>
    :root{
      --bg:#fafafa; --text:#0a2540; --muted:#5b6b82; --line:#e5e7eb; --card:#ffffff;
      --green:#18a957; --accent:#0f9d58; --accent2:#2dd4bf; --warn:#d30000;
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    .wrap{max-width:1100px;margin:0 auto;padding:18px 14px 60px}
    .safe{background:#0a0a0a;color:#fff;font-size:12px;padding:6px 10px;text-align:left}

    .grid{display:grid;grid-template-columns:minmax(0,1fr) 360px;gap:18px;align-items:start}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}

    .card{background:#fff;border:1px solid var(--line);padding:22px;border-radius:12px}
    .page-title{font-size:28px;font-weight:900;margin:6px 0 14px;display:flex;align-items:center;gap:8px}
    .stars{color:#f6b80c;font-size:15px}
    .reviews{color:var(--muted);font-size:13px;margin-left:6px}

    .h2{font-size:18px;font-weight:800;margin:10px 0 14px}
    .sub{font-size:13px;color:#5b6b82;margin-top:-6px}

    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .form-grid-1{display:grid;grid-template-columns:1fr;gap:10px}
    @media(max-width:620px){.form-grid{grid-template-columns:1fr}}

    .label{font-weight:700;font-size:13px;margin:4px 0 4px;color:#334}
    .input,.select,.el{
      width:100%; background:#fff; border:1px solid #cfd6e4; border-radius:10px; padding:12px; font-size:15px; outline:none;
    }

    .btn{
      width:100%; border:none; border-radius:12px; padding:12px 16px; font-weight:900; font-size:16px; cursor:pointer;
      background:#16a34a; color:#fff;
    }
    .btn:disabled{opacity:.65; cursor:not-allowed}
    .btn.muted{ background:#f1f4f8; color:#20324d; border:1px solid var(--line); }

    .logos{display:flex;gap:10px;align-items:center;margin-top:12px;justify-content:center}
    .logos img{height:20px;width:auto;display:block}

    .err{display:none;background:#fff1f1;border:1px solid #f5bcbc;color:#9a1a1a;padding:10px;border-radius:10px;font-size:14px;margin-top:10px}
    .err[aria-hidden="false"]{display:block}

    /* Sidebar widgets (same style family as IT) */
    .widget{background:#fff;border:1px solid var(--line);border-radius:12px;padding:16px}
    .widget + .widget{margin-top:12px}
    .w-title{font-weight:800;font-size:16px;margin:2px 0 10px}
    .order-row{display:flex;justify-content:space-between;font-size:14px;padding:6px 0;border-top:1px dashed #e6eaf1}
    .order-row:first-of-type{border-top:none}
    .tiny{font-size:12px;color:var(--muted)}
    .delivery{
      display:flex;align-items:center;gap:12px;border:1px dashed #d9e2ef;background:#f7fbff;padding:12px;border-radius:10px;
    }
    .delivery img{width:52px;height:52px;border-radius:8px;object-fit:cover;border:1px solid #e6eaf1;background:#fff}
    .trust{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;text-align:center}
    .trust .box{border:1px solid var(--line);border-radius:10px;padding:8px}
    .trust .big{font-weight:900;font-size:18px}
    .trust .small{font-size:12px;color:#5b6b82}

    .step{display:none}
    .step[aria-hidden="false"]{display:block}

    .el{padding:10px 12px;border-radius:10px;border:1px solid #cfd6e4}

    .loading-overlay{
      position:fixed; inset:0; background:rgba(246,249,252,.92);
      display:none; align-items:center; justify-content:center; z-index:9999;
    }
    .loading-overlay[aria-hidden="false"]{display:flex}
    .loading-box{
      width:min(92vw,460px); background:#fff; border:1px solid #e6edf5;
      border-radius:14px; box-shadow:0 6px 18px rgba(0,0,0,.06); padding:20px; text-align:center; color:#2a3b55
    }
    .loading-title{font-weight:800;margin:2px 0 10px;font-size:18px}
    .progress-wrap{width:100%;height:10px;background:#ecf1f8;border-radius:999px;overflow:hidden}
    .progress-bar{width:0%;height:100%;background:linear-gradient(90deg,#7aa3ff,#2dd4bf);animation:loadingBar 2.2s ease-in-out infinite}
    @keyframes loadingBar{0%{width:0%}60%{width:80%}100%{width:100%}}
  </style>
</head>

<body>
  <div class="safe">SSL Sikker Betaling</div>

  <div class="wrap">
    <div class="page-title">
      Sikker Checkout <span style="font-size:18px">üîí</span>
      <span class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
      <span class="reviews">(2777 anmeldelser)</span>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <!-- STEP 1 -->
        <section id="step1" class="step" aria-hidden="false">
          <div class="h2">1. Leveringsoplysninger</div>

          <div class="form-grid">
            <div>
              <div class="label">Fornavn</div>
              <input id="firstName" class="input" autocomplete="given-name">
            </div>
            <div>
              <div class="label">Efternavn</div>
              <input id="lastName" class="input" autocomplete="family-name">
            </div>
          </div>

          <div class="form-grid">
            <div style="grid-column:1 / -1">
              <div class="label">Adresse</div>
              <input id="billingStreet" class="input" autocomplete="address-line1">
            </div>
            <div>
              <div class="label">Postnummer</div>
              <input id="billingPostcode" class="input" autocomplete="postal-code">
            </div>
            <div>
              <div class="label">By</div>
              <input id="billingCity" class="input" autocomplete="address-level2">
            </div>
          </div>

          <div class="form-grid">
            <div>
              <div class="label">E-mail</div>
              <input id="emailInput" class="input" type="email" autocomplete="email" required>
            </div>
            <div>
              <div class="label">Land</div>
              <input id="billingCountry" class="input" value="Danmark" readonly>
            </div>
          </div>

          <div class="form-grid">
            <div>
              <div class="label">Landekode</div>
              <select id="phonePrefix" class="select" aria-label="Landekode">
                <option value="+45">+45 ‚Äî Danmark</option>
              </select>
            </div>
            <div>
              <div class="label">Telefon</div>
              <input id="phoneNumber" class="input" inputmode="tel" autocomplete="tel-national">
            </div>
          </div>

          <!-- Hidden full name (keeps payment code same structure as IT) -->
          <input id="nameInput" class="input" style="display:none">

          <button id="nextBtn" class="btn">Forts√¶t</button>

          <div class="logos">
            <img src="/visa.png" alt="Visa">
            <img src="/mastercard.png" alt="Mastercard">
            <img src="/amex.png" alt="American Express">
            <img src="/discover.jpg" alt="Discover">
          </div>
        </section>

        <!-- STEP 2 -->
        <section id="step2" class="step" aria-hidden="true">
          <div class="h2">2. Betaling</div>
          <p class="sub">Kortoplysninger krypteres og behandles sikkert af Stripe.</p>

          <div class="form-grid-1">
            <div>
              <div class="label">Kortnummer</div>
              <div id="card-number" class="el"></div>
            </div>
            <div class="form-grid">
              <div>
                <div class="label">Udl√∏b</div>
                <div id="card-expiry" class="el"></div>
              </div>
              <div>
                <div class="label">CVC</div>
                <div id="card-cvc" class="el"></div>
              </div>
            </div>
          </div>

          <!-- Logos under card fields -->
          <div class="logos" style="justify-content:flex-start">
            <img src="/visa.png" alt="Visa">
            <img src="/mastercard.png" alt="Mastercard">
            <img src="/amex.png" alt="American Express">
            <img src="/discover.jpg" alt="Discover">
          </div>

          <div id="err" class="err" role="alert" aria-hidden="true"></div>

          <div style="display:flex; gap:10px; margin-top:12px">
            <button id="backBtn" class="btn muted" style="width:40%">‚Üê Tilbage</button>
            <button id="payNow" class="btn" style="width:60%">Betal sikkert</button>
          </div>

          <p class="sub" style="text-align:center; margin-top:10px">üîí Krypteret forbindelse ¬∑ Behandles af Stripe</p>
        </section>
      </div>

      <!-- RIGHT SIDEBAR -->
      <aside>
        <div class="widget">
          <div class="w-title" style="text-align:center">Hvad vores kunder siger</div>
          <div style="text-align:center; font-weight:700; margin-bottom:4px">Fenella Lara</div>
          <div style="text-align:center; color:#f6b80c; letter-spacing:1px">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
          <p class="tiny" style="text-align:center; margin-top:8px">
            Min ordre ankom i g√•r. Fantastisk oplevelse!
          </p>
        </div>

        <div class="widget">
          <div class="delivery">
            <img id="sidebarImg" alt="" src="">
            <div>
              <div style="font-weight:800">Hurtig levering til din adresse</div>
              <div class="tiny">3‚Äì5 hverdage</div>
            </div>
            <div style="margin-left:auto; font-weight:800">Gratis</div>
          </div>

          <div class="w-title" style="margin-top:14px">Ordreoversigt</div>
          <div class="order-row"><span>Total</span><span id="orderTotal">Kr 15.00</span></div>

          <div class="tiny" style="margin-top:10px; line-height:1.5">
            üóÉÔ∏è Kun f√• tilbage p√• lager<br>
            üëÄ <span id="viewingNow">31</span> personer kigger lige nu<br>
            ‚úÖ <span id="recentBuyer">K****n</span> k√∏bte dette (10 minutter siden)<br>
            üí≥ <span id="purchasedCount">715</span> k√∏b de sidste 7 dage
          </div>
        </div>

        <div class="widget">
          <div class="w-title">TRYG HANDEL</div>
          <div class="trust">
            <div class="box">
              <div class="big">99%</div>
              <div class="small">Positive anmeldelser</div>
            </div>
            <div class="box">
              <div class="big">Sikkert</div>
              <div class="small">Krypteret betaling</div>
            </div>
            <div class="box">
              <div class="big">DKK</div>
              <div class="small">K√∏berbeskyttelse</div>
            </div>
          </div>

          <div class="logos" style="margin-top:12px; justify-content:center">
            <img src="/visa.png" alt="Visa">
            <img src="/mastercard.png" alt="Mastercard">
            <img src="/amex.png" alt="American Express">
            <img src="/discover.jpg" alt="Discover">
          </div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Loading overlay -->
  <div id="loading-overlay" class="loading-overlay" aria-hidden="true" style="display:none">
    <div class="loading-box">
      <div class="loading-title">Behandler betaling‚Ä¶</div>
      <div class="progress-wrap"><div class="progress-bar"></div></div>
      <p class="sub" style="margin-top:10px">Vent venligst ‚Äî det kan tage et par sekunder.</p>
    </div>
  </div>

  <script src="https://js.stripe.com/v3"></script>
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      // ----- DOM -----
      const step1 = document.getElementById('step1');
      const step2 = document.getElementById('step2');
      const errBox = document.getElementById('err');
      const nextBtn = document.getElementById('nextBtn');
      const backBtn = document.getElementById('backBtn');

      const firstName = document.getElementById('firstName');
      const lastName  = document.getElementById('lastName');
      const nameInput = document.getElementById('nameInput');

      const phonePrefix = document.getElementById('phonePrefix');
      const phoneNumber = document.getElementById('phoneNumber');

      const billingStreet = document.getElementById('billingStreet');
      const billingCity = document.getElementById('billingCity');
      const billingCountry = document.getElementById('billingCountry'); // locked to Danmark
      const billingPostcode = document.getElementById('billingPostcode');

      const orderTotal = document.getElementById('orderTotal');
      const sidebarImg = document.getElementById('sidebarImg');

      // Keep your existing endpoints / keys (same structure as IT)
      const SUBSCRIBE_URL = "/api/stripe/one-time-33-95";
      const PUBLISHABLE_KEY = "pk_live_51SaxeyEV8OvsGiVpMTahrMGQMjZMXD1neiFffQPrybev0TQNcxvVaixH5TfQKzDBNKxLIqcuAgQ1ynYPWXe792D500VQ7Gcw6t";

      // Cosmetic total (if you want to keep DK price text here)
      try { orderTotal.textContent = 'Kr 15.00'; } catch {}

      function show(o){ o?.setAttribute('aria-hidden','false'); }
      function hide(o){ o?.setAttribute('aria-hidden','true'); }

      // Loading overlay (same pattern as IT)
      const overlay = document.getElementById('loading-overlay');
      function showLoading(){ overlay.style.display='flex'; overlay.setAttribute('aria-hidden','false'); }
      function hideLoading(){ overlay.setAttribute('aria-hidden','true'); overlay.style.display='none'; }
      hideLoading();

      // Put any product image in sidebar if affiliates provide it (optional, matches IT behavior pattern)
      (function hydrateSidebarImage(){
        const qs = new URLSearchParams(window.location.search);
        const imgUrlRaw = qs.get('sub2') || qs.get('img') || qs.get('image') || '';
        if (!imgUrlRaw) return;
        try{
          const decoded = decodeURIComponent(imgUrlRaw);
          if (/^https?:\/\//i.test(decoded)){
            sidebarImg.src = decoded;
          }
        }catch{}
      })();

      // ===== URL prefill (same as IT) =====
      const qs = new URLSearchParams(window.location.search);

      // ===== SOP1 title replace (ONLY CHANGE ADDED) =====
      try{
        const sop1Raw = qs.get('sub1');
        if (sop1Raw){
          const sop1 = decodeURIComponent(sop1Raw);

          // Top title: replace ONLY the leading text node (keeps üîí + stars + reviews exactly)
          const pageTitleEl = document.querySelector('.page-title');
          if (pageTitleEl){
            for (const n of pageTitleEl.childNodes){
              if (n && n.nodeType === Node.TEXT_NODE && n.textContent.trim().length){
                n.textContent = sop1 + ' ';
                break;
              }
            }
          }

          // Sidebar title next to image: target the exact "Hurtig levering..." line
          const img = document.getElementById('sidebarImg');
          if (img && img.parentElement && img.parentElement.classList.contains('delivery')){
            const textWrap = img.nextElementSibling; // the <div> containing the two lines
            const titleLine = textWrap && textWrap.firstElementChild; // the <div style="font-weight:800">...</div>
            if (titleLine) titleLine.textContent = sop1;
          }
        }
      }catch(e){}

      const urlPrefs = {
        first:   qs.get('sub3') || '',
        last:    qs.get('sub4') || '',
        street:  qs.get('sub5') || '',
        post:    qs.get('sub6') || '',
        city:    qs.get('sub7') || '',
        country: qs.get('sub8') || '',
        email:   qs.get('sub9') || '',
        phone:   qs.get('sub10') || ''
      };

      function applyContactPrefill(){
        if (urlPrefs.first) firstName.value = decodeURIComponent(urlPrefs.first);
        if (urlPrefs.last)  lastName.value  = decodeURIComponent(urlPrefs.last);
        if (urlPrefs.email) document.getElementById('emailInput').value = decodeURIComponent(urlPrefs.email);

        const raw = (urlPrefs.phone || '').trim();
        if (raw){
          phoneNumber.value = raw.replace(/[^\d]/g, '');
        }
      }

      function applyAddressPrefill(){
        if (urlPrefs.street)  billingStreet.value = decodeURIComponent(urlPrefs.street);
        if (urlPrefs.post)    billingPostcode.value = decodeURIComponent(urlPrefs.post);
        if (urlPrefs.city)    billingCity.value = decodeURIComponent(urlPrefs.city);
        // NOTE: DK page is locked to Danmark in UI; ignore sub8 for display consistency
      }

      applyContactPrefill();
      applyAddressPrefill();

      // ===== Lock Denmark (+45, Danmark) =====
      function lockToDenmark(){
        if (billingCountry) billingCountry.value = 'Danmark';
        if (phonePrefix){
          if (!Array.from(phonePrefix.options).some(o => o.value === '+45')) {
            phonePrefix.add(new Option('+45 ‚Äî Danmark', '+45'));
          }
          phonePrefix.value = '+45';
        }
      }
      lockToDenmark();
      setTimeout(lockToDenmark, 0);

      // Step navigation ‚Äî combine first/last into hidden full name
      nextBtn?.addEventListener('click', () => {
        nameInput.value = [firstName.value || '', lastName.value || ''].join(' ').trim();
        hide(step1); show(step2);
      });
      backBtn?.addEventListener('click', () => { hide(step2); show(step1); });

      // ===== Stripe (same structure as IT) =====
      let stripe, elements, cardNumber, cardExpiry, cardCvc;
      try{
        if(window.Stripe){
          stripe = Stripe(PUBLISHABLE_KEY);
          elements = stripe.elements();
          cardNumber = elements.create('cardNumber');
          cardExpiry = elements.create('cardExpiry');
          cardCvc    = elements.create('cardCvc');
          cardNumber.mount('#card-number');
          cardExpiry.mount('#card-expiry');
          cardCvc.mount('#card-cvc');
        }
      }catch(e){ console.warn('Stripe init skipped:', e); }

      document.getElementById('payNow')?.addEventListener('click', async () => {
        if(!stripe){ alert('Betaling er midlertidigt utilg√¶ngelig. Pr√∏v igen.'); return; }

        errBox?.setAttribute('aria-hidden','true');
        if (errBox) errBox.textContent = '';
        showLoading();

        const name = (nameInput.value || '').trim();
        const email = (document.getElementById('emailInput')?.value || '').trim();
        const raw = (phoneNumber?.value || '').replace(/[^0-9]/g,'');
        const fullPhone = raw ? ((phonePrefix?.value||'') + raw) : undefined;

        // DK ISO country for Stripe address
        const address = {
          line1: (billingStreet?.value||'').trim() || undefined,
          city: (billingCity?.value||'').trim() || undefined,
          country: 'DK',
          postal_code: (billingPostcode?.value||'').trim() || undefined
        };

        try{
          const pmRes = await stripe.createPaymentMethod({
            type: 'card',
            card: cardNumber,
            billing_details: { name: name||undefined, email: email||undefined, phone: fullPhone, address }
          });
          if(pmRes.error) throw new Error(pmRes.error.message);

          const resp = await fetch(SUBSCRIBE_URL, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({
              paymentMethodId: pmRes.paymentMethod.id,
              name, email,
              phone: fullPhone,
              address
            })
          });

          const data = await resp.json();
          if(!data.clientSecret) throw new Error(data.error || 'Kunne ikke starte betalingen');

          const conf = await stripe.confirmCardPayment(data.clientSecret);
          if(conf.error) throw new Error(conf.error.message);
          if(!(conf.paymentIntent && conf.paymentIntent.status === 'succeeded')) throw new Error('Betalingen blev ikke gennemf√∏rt');

          // Success redirect builder (same pattern as IT, DK target URL)
          (function(){
            const TRACKER_URL = 'https://cudsr.bemobtrcks.com/go/e1420adb-fbc5-4cfe-b0f1-10615c05e062';
            const pid = (conf && conf.paymentIntent && conf.paymentIntent.id) || data.paymentIntentId || '';
            const qp = new URLSearchParams(pid ? { v: pid } : { t: String(Date.now()) });

            // forward affiliate click id if stored (same pattern as IT)
            try{
              const ck = document.cookie.match(/(?:^|; )aff_sub_id=([^;]*)/);
              const sub = ck ? decodeURIComponent(ck[1]) : (localStorage.getItem('aff_sub_id') || '');
              if (sub) {
                qp.set('sub_id',  sub);
                qp.set('subid',   sub);
                qp.set('aff_sub', sub);
                qp.set('click_id',sub);
                qp.set('cid',     sub);
                qp.set('tid',     sub);
              }
            }catch(e){}

            // forward affiliate pixel id if present (same as IT)
            try{
              const srcQs = new URLSearchParams(location.search);
              const affiliatePixel = srcQs.get('pixel') || srcQs.get('fb_pixel') || srcQs.get('fbp');
              if (affiliatePixel) qp.set('pixel', affiliatePixel);
            }catch(e){}

            const sep = TRACKER_URL.includes('?') ? '&' : '?';
            window.location.href = TRACKER_URL + sep + qp.toString();
          })();

        }catch(err){
          if(errBox){
            errBox.textContent = err.message || 'Noget gik galt.';
            errBox.setAttribute('aria-hidden','false');
          }
          hideLoading();

          // Keep same failure redirect behavior as IT pattern (if you want DK-specific, tell me)
          window.location.href = 'https://www.united-defence-shield.com/7GQSPJ/27CC71Q';
        }
      });
    });
  </script>
</body>
</html>
