<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Secure Checkout</title>
  <meta name="referrer" content="no-referrer">

  <style>
    :root{
      --bg:#fafafa; --text:#0a2540; --muted:#5b6b82; --line:#e5e7eb;
      --card:#ffffff; --green:#18a957; --accent:#0f9d58;
      --accent2:#2dd4bf; --warn:#d30000; --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    }

    .safe{background:#0a0a0a; color:#fff; font-size:12px; padding:6px 10px}
    .wrap{max-width:1100px; margin:0 auto; padding:18px 14px 60px}

    .page-title{
      font-size:28px; font-weight:900; display:flex; gap:8px; margin:6px 0 14px;
    }
    .stars{ color:#f6b80c; font-size:15px }
    .reviews{ color:var(--muted); font-size:13px; margin-left:6px }

    .grid{
      display:grid; grid-template-columns:minmax(0,1fr) 360px; gap:18px;
    }
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }

    .card{
      background:#fff; border:1px solid var(--line);
      padding:22px; border-radius:12px;
    }

    .h2{ font-size:18px; font-weight:800; margin:10px 0 14px }
    .sub{ font-size:13px; color:#5b6b82 }

    .form-grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
    @media(max-width:620px){ .form-grid{grid-template-columns:1fr} }

    .input, .select, .el{
      width:100%; border:1px solid #cfd6e4; border-radius:10px; padding:12px;
      background:#fff; font-size:15px;
    }

    .btn{
      width:100%; padding:12px; border:none; border-radius:12px;
      background:#16a34a; color:#fff; cursor:pointer; font-weight:900;
    }

    .logos{display:flex; gap:10px; margin-top:12px}
    .logos img{height:20px}

    .err{
      display:none; background:#fff1f1; border:1px solid #f5bcbc;
      padding:10px; border-radius:10px; margin-top:10px; color:#9a1a1a;
    }
    .err[aria-hidden="false"]{display:block}

    .widget{
      background:#fff; border:1px solid var(--line);
      padding:16px; border-radius:12px;
    }
    .widget + .widget{margin-top:12px}

    .order-row{
      display:flex; justify-content:space-between;
      padding:6px 0; border-top:1px dashed #e6eaf1;
    }

    .delivery{
      display:flex; gap:12px; padding:12px;
      border:1px dashed #d9e2ef; border-radius:10px; background:#f7fbff;
    }
    .delivery img{
      width:52px;height:52px;object-fit:cover;border-radius:8px;
    }

    .trust{
      display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; text-align:center;
    }
    .trust .box{border:1px solid var(--line); padding:8px; border-radius:10px}

    .step{display:none}
    .step[aria-hidden="false"]{display:block}

    /* ZA Loading Overlay ‚Äî VERSION B */
    .loading-overlay{
      position:fixed; inset:0;
      background:rgba(246,249,252,.92);
      display:none; align-items:center; justify-content:center;
      z-index:9999;
    }
    .loading-overlay[aria-hidden="false"]{display:flex}

    .loading-box{
      width:min(92vw,460px); background:#fff;
      border:1px solid #e6edf5; border-radius:14px;
      box-shadow:0 6px 18px rgba(0,0,0,.06);
      padding:20px; text-align:center; color:#2a3b55;
    }

    .loading-title{
      font-weight:800; margin:2px 0 10px; font-size:18px;
    }

    .progress-wrap{
      width:100%; height:10px; background:#ecf1f8;
      border-radius:999px; overflow:hidden;
    }

    .progress-bar{
      width:0%; height:100%;
      background:linear-gradient(90deg,#7aa3ff,#2dd4bf);
      animation: loadingBar 2.2s ease-in-out infinite;
    }

    @keyframes loadingBar{
      0%{width:0%} 60%{width:80%} 100%{width:100%}
    }
  </style>
</head>

<body>

<div class="safe">Secure SSL Payment</div>

<div class="wrap">
  <div class="page-title">
    Secure Checkout üîí <span class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
    <span class="reviews">(2777 reviews)</span>
  </div>

  <div class="grid">

    <!-- LEFT SIDE (FORM) -->
    <div class="card">

      <!-- STEP 1 -->
      <section id="step1" class="step" aria-hidden="false">
        <div class="h2">1. Information</div>

        <div class="form-grid">
          <div>
            <div class="label">First name</div>
            <input id="firstName" class="input" placeholder="John">
          </div>
          <div>
            <div class="label">Last name</div>
            <input id="lastName" class="input" placeholder="Smith">
          </div>
        </div>

        <div class="form-grid">
          <div style="grid-column:1 / -1">
            <div class="label">Address</div>
            <input id="billingStreet" class="input">
          </div>
          <div>
            <div class="label">Postcode</div>
            <input id="billingPostcode" class="input">
          </div>
          <div>
            <div class="label">City</div>
            <input id="billingCity" class="input">
          </div>
        </div>

        <div class="form-grid">
          <div>
            <div class="label">Email</div>
            <input id="emailInput" class="input" type="email">
          </div>
          <div>
            <div class="label">Country</div>
            <select id="billingCountry" class="select"></select>
          </div>
        </div>

        <div class="form-grid">
          <div>
            <div class="label">Phone prefix</div>
            <select id="phonePrefix" class="select"></select>
          </div>
          <div>
            <div class="label">Phone</div>
            <input id="phoneNumber" class="input">
          </div>
        </div>

        <input id="nameInput" class="input" style="display:none">

        <button id="nextBtn" class="btn" type="button">Continue</button>

        <div class="logos">
          <img src="/visa.png">
          <img src="/mastercard.png">
          <img src="/amex.png">
          <img src="/discover.jpg">
        </div>
      </section>

      <!-- STEP 2 -->
      <section id="step2" class="step" aria-hidden="true">
        <div class="h2">2. Payment</div>
        <p class="sub">Card details are securely encrypted by Stripe.</p>

        <div class="form-grid-1">
          <div>
            <div class="label">Card number</div>
            <div id="card-number" class="el"></div>
          </div>

          <div class="form-grid">
            <div>
              <div class="label">Expiry</div>
              <div id="card-expiry" class="el"></div>
            </div>
            <div>
              <div class="label">CVC</div>
              <div id="card-cvc" class="el"></div>
            </div>
          </div>
        </div>

        <div id="err" class="err" aria-hidden="true"></div>

        <div style="display:flex; gap:10px; margin-top:12px">
          <button id="backBtn" class="btn muted" style="width:40%" type="button">‚Üê Back</button>
          <button id="payNow" class="btn" style="width:60%" type="button">Secure Payment</button>
        </div>
      </section>

    </div>
<!-- RIGHT SIDE (SUMMARY) -->
<aside>
  <div class="widget">
    <div class="w-title" style="text-align:center">What customers say</div>
    <div style="text-align:center;font-weight:700;">Fenella Lara</div>
    <div style="text-align:center;color:#f6b80c;">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
    <p class="tiny" style="text-align:center">Great experience, fast shipping!</p>
  </div>

  <div class="widget">
    <div class="delivery">
      <img id="sidebarImg">
      <div>
        <div style="font-weight:800">Fast Delivery</div>
        <div class="tiny">3‚Äì5 business days</div>
      </div>
      <div style="margin-left:auto;font-weight:800">Free</div>
    </div>

    <div class="w-title" style="margin-top:14px">Order Summary</div>

    <div id="orderItems"></div>

    <div class="order-row"><span>Total</span><span id="orderTotal"></span></div>
  </div>

  <div class="widget">
    <div class="w-title">TRUSTED SHOP</div>
    <div class="trust">
      <div class="box"><div class="big">99%</div><div class="small">Satisfaction</div></div>
      <div class="box"><div class="big">SSL</div><div class="small">Secure</div></div>
      <div class="box"><div class="big">$250k</div><div class="small">Buyer Protection</div></div>
    </div>
  </div>
</aside>

</div> <!-- end grid -->
</div> <!-- end wrap -->


<!-- LOADING OVERLAY -->
<div id="loading-overlay" class="loading-overlay" aria-hidden="true" style="display:none">
  <div class="loading-box">
    <div class="loading-title">Processing your payment‚Ä¶</div>
    <div class="progress-wrap"><div class="progress-bar"></div></div>
    <p class="sub" style="margin-top:10px">Please wait, this may take a few seconds.</p>
  </div>
</div>

<!-- Stripe -->
<script src="https://js.stripe.com/v3"></script>

<script>
/* -------------------------------------------------
   TIER-1 + TIER-2 COUNTRY LIST (billing + phone)
------------------------------------------------- */
const COUNTRY_LIST = [
  { code:"US", name:"United States", prefix:"+1" },
  { code:"CA", name:"Canada", prefix:"+1" },
  { code:"GB", name:"United Kingdom", prefix:"+44" },
  { code:"IE", name:"Ireland", prefix:"+353" },
  { code:"AU", name:"Australia", prefix:"+61" },
  { code:"NZ", name:"New Zealand", prefix:"+64" },
{ code:"ZA", name:"South Africa", prefix:"+27" },

  { code:"AT", name:"Austria", prefix:"+43" },
  { code:"BE", name:"Belgium", prefix:"+32" },
  { code:"DK", name:"Denmark", prefix:"+45" },
  { code:"FI", name:"Finland", prefix:"+358" },
  { code:"FR", name:"France", prefix:"+33" },
  { code:"DE", name:"Germany", prefix:"+49" },
  { code:"IT", name:"Italy", prefix:"+39" },
  { code:"NL", name:"Netherlands", prefix:"+31" },
  { code:"NO", name:"Norway", prefix:"+47" },
  { code:"PT", name:"Portugal", prefix:"+351" },
  { code:"ES", name:"Spain", prefix:"+34" },
  { code:"SE", name:"Sweden", prefix:"+46" },
  { code:"CH", name:"Switzerland", prefix:"+41" },
  { code:"CZ", name:"Czechia", prefix:"+420" },
  { code:"PL", name:"Poland", prefix:"+48" }
];

function populateCountrySelectors() {
  const countrySel = document.getElementById("billingCountry");
  const phoneSel = document.getElementById("phonePrefix");

  COUNTRY_LIST.forEach(c => {
    const opt1 = document.createElement("option");
    opt1.value = c.code;
    opt1.textContent = c.name;
    countrySel.appendChild(opt1);

    const opt2 = document.createElement("option");
    opt2.value = c.prefix;
    opt2.textContent = `${c.prefix} ‚Äî ${c.name}`;
    phoneSel.appendChild(opt2);
  });

  // auto-set prefix when country changes
  countrySel.addEventListener("change", () => {
    const match = COUNTRY_LIST.find(c => c.code === countrySel.value);
    if (match) phoneSel.value = match.prefix;
  });
}

/* -------------------------------------------------
   LOAD CART + CUSTOMER DATA FROM PLUGIN
------------------------------------------------- */
let CART_TOTAL = 0;
let CART_ITEMS = [];
let CUSTOMER = {};

async function loadCartTotals() {
  const res = await fetch("/wp-admin/admin-ajax.php?action=api_cart_totals");
  const json = await res.json();
  CART_TOTAL = json?.data?.total || 0;
  document.getElementById("orderTotal").textContent = "$" + CART_TOTAL.toFixed(2);
}

async function loadCartItems() {
  const res = await fetch("/wp-admin/admin-ajax.php?action=api_cart_items");
  const json = await res.json();
  CART_ITEMS = json?.data || [];

  const container = document.getElementById("orderItems");
  container.innerHTML = "";

  CART_ITEMS.forEach(item => {
    const row = document.createElement("div");
    row.className = "order-row";
    row.innerHTML = `
      <span>${item.name} √ó ${item.qty}</span>
      <span>$${item.line_total.toFixed(2)}</span>
    `;
    container.appendChild(row);
  });

  // Show first image in sidebar
  if (CART_ITEMS[0]?.image) {
    document.getElementById("sidebarImg").src = CART_ITEMS[0].image;
  }
}

async function loadCustomer() {
  const res = await fetch("/wp-admin/admin-ajax.php?action=api_customer_data");
  const json = await res.json();
  CUSTOMER = json?.data || {};

  // Fill inputs
  firstName.value = CUSTOMER.first_name || "";
  lastName.value  = CUSTOMER.last_name || "";
  billingStreet.value = CUSTOMER.address || "";
  billingPostcode.value = CUSTOMER.postcode || "";
  billingCity.value = CUSTOMER.city || "";
  emailInput.value = CUSTOMER.email || "";

  // Set country + prefix
  if (CUSTOMER.country) billingCountry.value = CUSTOMER.country;
  const c = COUNTRY_LIST.find(x => x.code === CUSTOMER.country);
  if (c) phonePrefix.value = c.prefix;

  // Extract phone
  if (CUSTOMER.phone) phoneNumber.value = CUSTOMER.phone.replace(/^\+\d+/, "");
}

/* -------------------------------------------------
   INITIAL LOAD ON PAGE START
------------------------------------------------- */
window.addEventListener("DOMContentLoaded", async () => {
  populateCountrySelectors();
  await loadCartTotals();
  await loadCartItems();
  await loadCustomer();
});
</script>
<script>
/* -------------------------------------------------
   STRIPE INITIALISATION
------------------------------------------------- */
const stripe = Stripe("pk_live_51SaxeyEV8OvsGiVpMTahrMGQMjZMXD1neiFffQPrybev0TQNcxvVaixH5TfQKzDBNKxLIqcuAgQ1ynYPWXe792D500VQ7Gcw6t");
const elements = stripe.elements();

const cardNumber = elements.create("cardNumber");
const cardExpiry = elements.create("cardExpiry");
const cardCvc    = elements.create("cardCvc");

cardNumber.mount("#card-number");
cardExpiry.mount("#card-expiry");
cardCvc.mount("#card-cvc");

/* -------------------------------------------------
   STEP SWITCHING
------------------------------------------------- */
nextBtn.addEventListener("click", () => {
  nameInput.value = `${firstName.value} ${lastName.value}`.trim();
  step1.setAttribute("aria-hidden","true");
  step2.setAttribute("aria-hidden","false");
});

backBtn.addEventListener("click", () => {
  step2.setAttribute("aria-hidden","true");
  step1.setAttribute("aria-hidden","false");
});

/* -------------------------------------------------
   CREATE WOOCOMMERCE ORDER (AFTER PAYMENT)
------------------------------------------------- */
async function createWooOrder(transactionId) {
  const payload = {
    billing: {
      first_name: firstName.value,
      last_name: lastName.value,
      email: emailInput.value,
      phone: phonePrefix.value + phoneNumber.value,
      country: billingCountry.value,
      address_1: billingStreet.value,
      city: billingCity.value,
      postcode: billingPostcode.value
    },
    products: CART_ITEMS,     // full list from plugin
    total: CART_TOTAL         // USD
  };

  const res = await fetch("/wp-admin/admin-ajax.php?action=api_create_order", {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });

  const json = await res.json();
  if (!json.success) throw new Error("Failed to create WooCommerce order");

  const orderId = json.data.order_id;

  // Mark order paid
  const res2 = await fetch("/wp-admin/admin-ajax.php?action=api_complete_order", {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify({
      order_id: orderId,
      transaction_id: transactionId
    })
  });

  const json2 = await res2.json();
  if (!json2.success) throw new Error("Failed to complete WooCommerce order");

  return orderId;
}

/* -------------------------------------------------
   PAYMENT HANDLER
------------------------------------------------- */
const payBtn = document.getElementById("payNow");

payBtn.addEventListener("click", async () => {

  // Prevent double submit
  payBtn.disabled = true;
  payBtn.style.opacity = "0.6";
  payBtn.style.pointerEvents = "none";

  errBox.setAttribute("aria-hidden","true");

  // Show ZA loading overlay
  const overlay = document.getElementById("loading-overlay");
  overlay.style.display = "flex";
  overlay.setAttribute("aria-hidden","false");

  const billingName = nameInput.value;
  const email = emailInput.value;
  const phone = phonePrefix.value + phoneNumber.value;
  const address = {
    line1: billingStreet.value,
    city: billingCity.value,
    postal_code: billingPostcode.value,
    country: billingCountry.value
  };

  try {
    /* ---------------------------------------------
        1) Create PaymentMethod
    --------------------------------------------- */
    const pm = await stripe.createPaymentMethod({
      type: "card",
      card: cardNumber,
      billing_details: { name: billingName, email, phone, address }
    });

    if (pm.error) throw new Error(pm.error.message);

    /* ---------------------------------------------
        2) Create PaymentIntent on OUR backend
           fixed USD, dynamic amount
    --------------------------------------------- */
    const intentRes = await fetch("/api/stripe/dynamic", {
      method: "POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        amount: CART_TOTAL,
        paymentMethodId: pm.paymentMethod.id,
        billingName,
        email,
        phone,
        address
      })
    });

    const intentJson = await intentRes.json();
    if (!intentJson.clientSecret)
      throw new Error(intentJson.error || "Could not create payment.");

    /* ---------------------------------------------
        3) Confirm Stripe Payment
    --------------------------------------------- */
    const confirm = await stripe.confirmCardPayment(intentJson.clientSecret, {
      payment_method: pm.paymentMethod.id
    });

    if (confirm.error) throw new Error(confirm.error.message);
    if (confirm.paymentIntent.status !== "succeeded")
      throw new Error("Payment not completed.");

    const transactionId = confirm.paymentIntent.id;

    /* ---------------------------------------------
        4) Create WooCommerce order AFTER payment
    --------------------------------------------- */
    await createWooOrder(transactionId);

    /* ---------------------------------------------
        5) Redirect to Bemob success link
    --------------------------------------------- */
    window.location.href =
      "https://cudsr.bemobtrcks.com/go/e1420adb-fbc5-4cfe-b0f1-10615c05e062";

  } catch (err) {

    errBox.textContent = err.message;
    errBox.setAttribute("aria-hidden","false");

    // Re-enable button
    payBtn.disabled = false;
    payBtn.style.opacity = "1";
    payBtn.style.pointerEvents = "auto";

    overlay.style.display = "none";
    overlay.setAttribute("aria-hidden","true");

  }

});
</script>

</body>
</html>

