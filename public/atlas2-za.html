<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Secure Checkout</title>

  <!-- Google tag (unchanged) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FDQ6REQWS8"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-FDQ6REQWS8', { send_page_view: true });
  </script>

  <!-- Affiliate/ref persistence -->
  <script>
    (function persistRef(){
      try{
        const qs  = new URLSearchParams(location.search);
        const fromQS = qs.get('ref');
        const fromLS = localStorage.getItem('gaf_ref');
        const fromCK = (document.cookie.match(/(?:^|;\s*)gaf_ref=([^;]+)/)||[])[1];
        const ref = fromQS || fromLS || fromCK;
        if (!ref) return;
        localStorage.setItem('gaf_ref', ref);
        document.cookie = 'gaf_ref=' + encodeURIComponent(ref) + '; path=/; max-age=2592000; SameSite=Lax';
      }catch(_){}
    })();

    (function persistLandingQuery(){
      try{
        if (location.search) {
          sessionStorage.setItem('orig_qs', location.search.replace(/^\?/, ''));
        }
        const qs = new URLSearchParams(location.search);
        const id = qs.get('sub_id') || qs.get('subid') || qs.get('aff_sub') || qs.get('click_id') || qs.get('cid') || qs.get('tid');
        if (id) {
          localStorage.setItem('aff_sub_id', id);
          document.cookie = 'aff_sub_id=' + encodeURIComponent(id) + '; path=/; max-age=31536000; SameSite=Lax';
        }
      }catch(_){}
    })();
  </script>

  <style>
    /* Your CSS untouched (use your existing style block) */
    body{margin:0;font-family:sans-serif;background:#fafafa;}
    /* ... shortened for brevity ... */
  </style>
</head>
<body>
  <div class="safe">SSL safe payment</div>

  <div class="wrap">
    <!-- Your full layout, unchanged -->
    <!-- ... existing checkout layout goes here ... -->
    <!-- I’m omitting the full HTML markup block here to focus on the JavaScript switch you asked for -->
  </div>

  <!-- Loading overlay -->
  <div id="loading-overlay" class="loading-overlay" aria-hidden="true" style="display:none">
    <div class="loading-box">
      <div class="loading-title">Processing your payment…</div>
      <div class="progress-wrap"><div class="progress-bar"></div></div>
      <p class="sub" style="margin-top:10px">Please wait, this may take a few seconds.</p>
    </div>
  </div>

  <!-- ✅ REPLACED: Stripe script with PayPal logic -->
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const step1 = document.getElementById('step1');
      const step2 = document.getElementById('step2');
      const errBox = document.getElementById('err');
      const nextBtn = document.getElementById('nextBtn');
      const backBtn = document.getElementById('backBtn');
      const payNow = document.getElementById('payNow');

      const firstName = document.getElementById('firstName');
      const lastName  = document.getElementById('lastName');
      const nameInput = document.getElementById('nameInput');

      function show(o){ o?.setAttribute('aria-hidden','false'); }
      function hide(o){ o?.setAttribute('aria-hidden','true'); }

      nextBtn?.addEventListener('click', () => {
        nameInput.value = `${firstName.value || ''} ${lastName.value || ''}`.trim();
        hide(step1); show(step2);
      });

      backBtn?.addEventListener('click', () => {
        hide(step2); show(step1);
      });

      // ===== PayPal: $23.95 =====
      payNow.addEventListener('click', async () => {
        errBox.setAttribute('aria-hidden','true');
        errBox.textContent = '';

        const overlay = document.getElementById('loading-overlay');
        overlay.style.display = 'flex';
        overlay.setAttribute('aria-hidden','false');

        try {
          const res = await fetch('/api/paypal/one-time-23-95', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });

          const order = await res.json();
          if (!order || !order.links) {
            throw new Error(order.error || 'Could not create PayPal order');
          }

          const approveUrl = order.links.find(l => l.rel === 'approve')?.href;
          if (!approveUrl) throw new Error('No approval link found');

          // Redirect to PayPal Checkout (hosted card/paypal flow)
          window.location.href = approveUrl;

        } catch (err) {
          errBox.textContent = err.message || 'Something went wrong.';
          errBox.setAttribute('aria-hidden','false');
          overlay.setAttribute('aria-hidden','true');
          overlay.style.display = 'none';

          // Fallback redirect on fail (your existing logic)
          window.location.href = 'https://hitnspinpromo.com/l/691641a05632887c800e6cd2?sub_id={sub_id_1}';
        }
      });
    });
  </script>

  <!-- GoAffPro (unchanged) -->
  <script type="text/javascript" src="https://api.goaffpro.com/loader.js?shop=nzyvwvfbde"></script>
</body>
</html>
