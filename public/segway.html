<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover" />
<title>S√§ker betalning ‚Ä¢ Segway-Ninebot MAX G2</title>

<!-- Google tag -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-FDQ6REQWS8"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-FDQ6REQWS8');
</script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet"/>

<style>
:root{--brand:#0f6bd6;--line:rgba(0,0,0,.1)}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,system-ui,Arial;
  background:url("segway.png") center/cover no-repeat fixed;
  display:flex;
  justify-content:center;
}
.wrap{max-width:860px;width:100%;padding:20px}
.card{
  background:rgba(255,255,255,.96);
  border-radius:18px;
  padding:24px;
  box-shadow:0 10px 28px rgba(0,0,0,.2);
}
.step{display:none}
.step[aria-hidden="false"]{display:block}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:640px){.grid{grid-template-columns:1fr}}
.input,.el{
  width:100%;
  padding:12px;
  border:2px solid var(--line);
  border-radius:12px;
}
.btn{
  padding:12px 18px;
  border-radius:12px;
  font-weight:800;
  cursor:pointer;
  border:2px solid #000;
  background:#fff;
}
.btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
.btn-row{display:flex;gap:12px;margin-top:14px}

#err{
  display:none;
  margin-top:10px;
  background:#fde9eb;
  border:1px solid #e5b2b8;
  padding:8px;
  border-radius:10px;
  color:#b00020;
}
#err[aria-hidden="false"]{display:block}

.loading-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.65);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.loading-overlay[aria-hidden="false"]{display:flex}
.loading-box{
  background:#fff;
  padding:22px;
  border-radius:16px;
  width:90%;
  max-width:420px;
  text-align:center;
}
.progress{height:12px;background:#ddd;border-radius:999px;overflow:hidden}
.bar{height:100%;width:0;background:linear-gradient(90deg,#0f6bd6,#67b3ff);animation:load 2.2s infinite}
@keyframes load{0%{width:0}60%{width:80%}100%{width:100%}}
</style>
</head>

<script src="https://api.goaffpro.com/loader.js?shop=nzyvwvfbde"></script>

<body>

<div class="wrap">

<section id="step1" class="card step" aria-hidden="false">
  <h2>Reservera din Segway-Ninebot MAX G2</h2>

  <div class="grid">
    <input id="nameInput" class="input" placeholder="Fullst√§ndigt namn">
    <input id="emailInput" class="input" type="email" placeholder="E-postadress">
    <input id="phoneNumber" class="input" placeholder="Telefonnummer">
  </div>

  <div class="btn-row">
    <button id="nextBtn" class="btn primary" type="button">N√§sta steg ‚Üí</button>
  </div>
</section>

<section id="step2" class="card step" aria-hidden="true">
  <h2>S√§ker betalning</h2>

  <div class="grid">
    <input id="billingStreet" class="input" placeholder="Gatuadress">
    <input id="billingCity" class="input" placeholder="Stad">
    <input id="billingPostcode" class="input" placeholder="Postnummer">
    <input class="input" value="Sverige" disabled>
  </div>

  <div id="card-number" class="el"></div>
  <div class="grid">
    <div id="card-expiry" class="el"></div>
    <div id="card-cvc" class="el"></div>
  </div>

  <div id="err" aria-hidden="true"></div>

  <div class="btn-row">
    <button id="backBtn" class="btn">‚Üê Tillbaka</button>
    <button id="payNow" class="btn primary">Betala s√§kert</button>
  </div>
</section>

</div>

<div id="loading-overlay" class="loading-overlay" aria-hidden="true">
  <div class="loading-box">
    <strong>Behandlar betalning‚Ä¶</strong>
    <div class="progress"><div class="bar"></div></div>
  </div>
</div>

<script src="https://js.stripe.com/v3"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {

  /* üîë Stripe */
  const stripe = Stripe("pk_live_51SaxeyEV8OvsGiVpMTahrMGQMjZMXD1neiFffQPrybev0TQNcxvVaixH5TfQKzDBNKxLIqcuAgQ1ynYPWXe792D500VQ7Gcw6t");
  const elements = stripe.elements();

  const cardNumber = elements.create("cardNumber");
  const cardExpiry = elements.create("cardExpiry");
  const cardCvc    = elements.create("cardCvc");

  cardNumber.mount("#card-number");
  cardExpiry.mount("#card-expiry");
  cardCvc.mount("#card-cvc");

  /* ‚úÖ EXPLICIT DOM BINDINGS (THIS WAS MISSING) */
  const nameInput       = document.getElementById("nameInput");
  const emailInput      = document.getElementById("emailInput");
  const phoneNumber     = document.getElementById("phoneNumber");
  const billingStreet   = document.getElementById("billingStreet");
  const billingCity     = document.getElementById("billingCity");
  const billingPostcode = document.getElementById("billingPostcode");

  const step1 = document.getElementById("step1");
  const step2 = document.getElementById("step2");
  const nextBtn = document.getElementById("nextBtn");
  const backBtn = document.getElementById("backBtn");
  const payNow  = document.getElementById("payNow");
  const err     = document.getElementById("err");
  const overlay = document.getElementById("loading-overlay");

  nextBtn.onclick = () => {
    step1.setAttribute("aria-hidden","true");
    step2.setAttribute("aria-hidden","false");
  };

  backBtn.onclick = () => {
    step2.setAttribute("aria-hidden","true");
    step1.setAttribute("aria-hidden","false");
  };

  payNow.onclick = async () => {
    payNow.disabled = true;
    overlay.setAttribute("aria-hidden","false");
    err.setAttribute("aria-hidden","true");

    /* ‚úÖ FULL CUSTOMER DETAILS SENT TO STRIPE */
    const billingDetails = {
      name: nameInput.value.trim(),
      email: emailInput.value.trim(),
      phone: phoneNumber.value.trim(),
      address:{
        line1: billingStreet.value.trim(),
        city: billingCity.value.trim(),
        postal_code: billingPostcode.value.trim(),
        country:"SE"
      }
    };

    try{
      const pm = await stripe.createPaymentMethod({
        type:"card",
        card: cardNumber,
        billing_details: billingDetails
      });
      if(pm.error) throw pm.error;

      const res = await fetch("/api/stripe/one-time-33-95",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          paymentMethodId: pm.paymentMethod.id,
          billingDetails
        })
      });

      const data = await res.json();

      const conf = await stripe.confirmCardPayment(data.clientSecret,{
        payment_method: pm.paymentMethod.id
      });
      if(conf.error) throw conf.error;

      window.location.href = "thankyou-iphone.html";

    }catch(e){
      err.textContent = e.message || "Betalningen misslyckades";
      err.setAttribute("aria-hidden","false");
      overlay.setAttribute("aria-hidden","true");
      payNow.disabled = false;
    }
  };
});
</script>

</body>
</html>
